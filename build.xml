<?xml version="1.0" encoding="UTF-8"?>
<project name="Polyglot2" default="archive">
	<property name="classes" location="build/classes"/>
	<property name="tmp" location="build/tmp"/>
	<property name="javadocs" location="build/javadocs"/>

	<path id="classpath">
		<fileset dir="lib">
			<include name="**/*.jar"/>
		</fileset>
	</path>
	
	<target name="compile" description="Compiles the Java source code">
		<mkdir dir="${classes}"/>
		<javac srcdir="src" destdir="${classes}" classpathref="classpath"/>
	</target>
	
	<target name="archive" depends="compile" description="Creates the JAR file">
		<jar basedir="${classes}" destfile="build/Polyglot2.jar"/>
	</target>	
	
	<target name="iograph_archive" depends="compile" description="Archive the code needed for the I/O-graph applet">
		<mkdir dir="${tmp}"/>
		<copy todir="${tmp}">
			<fileset dir="${classes}">
				<include name="**/IOGraph*.class"/>
				<include name="**/Polyglot*.class"/>
			</fileset>
		</copy>
		<unjar src="lib/ncsa/Utilities.jar" dest="${tmp}"/>
		<jar basedir="${tmp}" destfile="build/IOGraphApplet.jar"/>
		<signjar jar="build/IOGraphApplet.jar" signedjar="build/IOGraphApplet-signed.jar" alias="mykey" storepass="isdapass"/>
	</target>
	
	<target name="installer" depends="archive" description="Build an installer for this project">
		<exec executable="C:/Program Files/Inno Setup 5/Compil32">
			<arg value="/cc"/>
			<arg value="Polyglot2.iss"/>
		</exec>
	</target>
	
	<target name="zip" depends="archive,javadocs" description="Build a zip file containing the installation">
		<mkdir dir="${tmp}"/>
		<mkdir dir="${tmp}/data"/>
		<copy todir="${tmp}/lib">
			<fileset dir="lib"/>
		</copy>
		<copy todir="${tmp}/scripts">
			<fileset dir="scripts"/>
		</copy>
		<copy todir="${tmp}/javadocs">
			<fileset dir="${javadocs}"/>
		</copy>
		<copy file="build/Polyglot2.jar" todir="${tmp}"/>
		<mkdir dir="${tmp}/tmp"/>
		<echo file="${tmp}/ICRServer.bat">java -cp "%~dp0lib/ncsa/Utilities.jar;%~dp0Polyglot2.jar" -Xmx1g edu.ncsa.icr.ICRServer %1 %2</echo>
		<echo file="${tmp}/ICRServer.ini" append="false">RootPath=tmp${line.separator}</echo>
		<echo file="${tmp}/ICRServer.ini" append="true">Port=30${line.separator}</echo>
		<echo file="${tmp}/ICRServer.ini" append="true">MaxOperationTime=30000${line.separator}</echo>
		<echo file="${tmp}/ICRServer.ini" append="true">MaxOperationAttempts=2${line.separator}</echo>
		<echo file="${tmp}/ICRServer.ini" append="true">EnableMonitors=true${line.separator}</echo>
		<echo file="${tmp}/ICRServer.ini" append="true">AHKScripts=scripts/ahk</echo>
		<echo file="${tmp}/ICRScriptDebugger.bat">java -cp "%~dp0lib/ncsa/Utilities.jar;%~dp0Polyglot2.jar" -Xmx1g edu.ncsa.icr.ICRScriptDebugger %1 %2</echo>
		<zip basedir="${tmp}" destfile="build/Polyglot2.zip"/>
	</target>
	
	<target name="polyglot_utils" depends="compile" description="Archive all the code needed by the web interface">
		<mkdir dir="${tmp}"/>
		<copy todir="${tmp}">
			<fileset dir="${classes}">
				<include name="**/polyglot/IOGraph*.class"/>
				<include name="**/polyglot/Polyglot*.class"/>
			</fileset>
		</copy>
		<unjar src="lib/ncsa/Utilities.jar" dest="${tmp}"/>
		<unjar src="web/utils/UploadApplet.jar" dest="${tmp}"/>
		<unjar src="web/utils/ModelViewer_Lite.jar" dest="${tmp}"/>
		<jar basedir="${tmp}" destfile="build/PolyglotUtils.jar"/>
		<signjar jar="build/PolyglotUtils.jar" signedjar="build/PolyglotUtils-signed.jar" alias="mykey" storepass="isdapass"/>
	</target>
	
	<target name="javadocs" description="Make javadocs">
		<mkdir dir="${javadocs}"/>
		<javadoc sourcepath="src" destdir="${javadocs}" packagenames="edu.ncsa.icr.*" classpathref="classpath"/>
	</target>
	
	<target name="clean_tmp" description="Deletes tmp folder">
		<delete dir="build/tmp"/>
	</target>
		
	<target name="clean" description="Deletes all generated files">
		<delete dir="build"/>
	</target>
</project>